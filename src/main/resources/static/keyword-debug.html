<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Instagram API Debug Console v2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Sora:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #f5f0e6;
        --bg-2: #eef6f3;
        --card: rgba(255, 255, 255, 0.86);
        --ink: #1d232d;
        --muted: #5f6b76;
        --accent: #f29f58;
        --accent-2: #2c9caf;
        --accent-3: #244f5d;
        --line: rgba(28, 33, 40, 0.1);
        --shadow: 0 18px 40px rgba(20, 24, 31, 0.12);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Sora", system-ui, -apple-system, sans-serif;
        color: var(--ink);
        background: radial-gradient(circle at 0% 0%, #ffe3c7, transparent 45%),
          radial-gradient(circle at 100% 0%, #cfe8e2, transparent 40%),
          linear-gradient(180deg, var(--bg), var(--bg-2));
        display: flex;
        justify-content: center;
        padding: 40px 20px 72px;
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background-image: radial-gradient(rgba(36, 79, 93, 0.08) 1px, transparent 0);
        background-size: 24px 24px;
        opacity: 0.4;
        pointer-events: none;
        z-index: 0;
      }

      .container {
        width: min(1200px, 100%);
        z-index: 1;
      }

      .header {
        display: flex;
        gap: 24px;
        align-items: flex-end;
        justify-content: space-between;
        margin-bottom: 20px;
      }

      .header h1 {
        margin: 0 0 8px;
        font-size: clamp(2rem, 2.5vw + 1rem, 3rem);
      }

      .header p {
        margin: 0;
        color: var(--muted);
        max-width: 560px;
      }

      .eyebrow {
        text-transform: uppercase;
        letter-spacing: 0.2em;
        font-size: 0.72rem;
        color: var(--accent-3);
      }

      .user-box {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 16px;
        min-width: 260px;
        box-shadow: var(--shadow);
      }

      label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
      }

      input,
      select,
      textarea,
      button {
        width: 100%;
        border-radius: 12px;
        border: 1px solid var(--line);
        padding: 10px 12px;
        font-size: 0.95rem;
        font-family: inherit;
        background: #fff;
        color: var(--ink);
      }

      textarea {
        min-height: 90px;
        resize: vertical;
        font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, monospace;
        font-size: 0.85rem;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: 2px solid rgba(44, 156, 175, 0.35);
        border-color: rgba(44, 156, 175, 0.5);
      }

      .tabs {
        display: inline-flex;
        gap: 6px;
        background: rgba(36, 79, 93, 0.08);
        padding: 6px;
        border-radius: 999px;
        margin-bottom: 20px;
      }

      .tab-btn {
        border: none;
        padding: 10px 18px;
        border-radius: 999px;
        background: transparent;
        color: var(--accent-3);
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease, transform 0.2s ease;
      }

      .tab-btn.active {
        background: linear-gradient(120deg, var(--accent), var(--accent-2));
        color: #1c2228;
        transform: translateY(-1px);
      }

      .tab-panel {
        display: none;
        animation: fadeUp 0.35s ease both;
      }

      .tab-panel.active {
        display: block;
      }

      .grid {
        display: grid;
        grid-template-columns: minmax(0, 0.95fr) minmax(0, 1.05fr);
        gap: 24px;
      }

      .card {
        background: var(--card);
        border-radius: 18px;
        border: 1px solid var(--line);
        box-shadow: var(--shadow);
        padding: 20px;
      }

      .card + .card {
        margin-top: 18px;
      }

      .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
        gap: 12px;
      }

      .card-header h2 {
        margin: 0;
        font-size: 1.1rem;
      }

      .badge {
        background: rgba(44, 156, 175, 0.12);
        color: var(--accent-3);
        font-size: 0.75rem;
        font-weight: 600;
        padding: 6px 10px;
        border-radius: 999px;
      }

      .field {
        margin-bottom: 14px;
      }

      .hidden {
        display: none;
      }

      .field-note {
        margin-top: 6px;
        font-size: 0.78rem;
        color: var(--muted);
      }

      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .check {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.88rem;
        color: var(--muted);
      }

      .check input {
        width: auto;
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }

      .btn {
        cursor: pointer;
        border: none;
        background: linear-gradient(120deg, var(--accent), var(--accent-2));
        color: #1c2228;
        font-weight: 600;
        padding: 10px 16px;
        width: auto;
      }

      .btn.secondary {
        background: rgba(36, 79, 93, 0.08);
        color: var(--accent-3);
        border: 1px solid rgba(36, 79, 93, 0.2);
      }

      .status {
        margin-top: 10px;
        font-size: 0.88rem;
        color: var(--muted);
      }

      .status.error {
        color: #b14634;
      }

      .status.success {
        color: #1f7a5a;
      }

      .payload {
        margin-top: 16px;
      }

      .payload-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.88rem;
        color: var(--muted);
        margin-bottom: 6px;
      }

      .copy-btn {
        border: 1px solid rgba(36, 79, 93, 0.2);
        background: rgba(36, 79, 93, 0.08);
        color: var(--accent-3);
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 0.75rem;
        cursor: pointer;
        width: auto;
      }

      .block {
        margin-bottom: 18px;
      }

      .block-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }

      .block-header h3 {
        margin: 0;
        font-size: 1rem;
      }

      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .chip {
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(44, 156, 175, 0.12);
        border: 1px solid rgba(44, 156, 175, 0.35);
        font-size: 0.82rem;
      }

      .chip.alt {
        background: rgba(242, 159, 88, 0.15);
        border-color: rgba(242, 159, 88, 0.4);
      }

      .raw {
        background: #1c232b;
        color: #f8f4ee;
        padding: 14px;
        border-radius: 12px;
        font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, monospace;
        font-size: 0.8rem;
        white-space: pre-wrap;
        word-break: break-word;
        min-height: 80px;
      }

      @keyframes fadeUp {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 960px) {
        .header {
          flex-direction: column;
          align-items: flex-start;
        }

        .user-box {
          width: 100%;
        }

        .grid {
          grid-template-columns: 1fr;
        }

        .row {
          grid-template-columns: 1fr;
        }
      }

      @media (prefers-reduced-motion: reduce) {
        .tab-panel {
          animation: none;
        }

        .tab-btn.active {
          transform: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header class="header">
        <div>
          <div class="eyebrow">Instagram API Debug v2</div>
          <h1>Debug Console</h1>
          <p>
            Two purpose-built tabs for API testing. Use Keyword Extract for prompt debugging
            and DM Message for end-to-end message generation.
          </p>
        </div>
        <div class="user-box">
          <label for="userId">Instagram Username</label>
          <input id="userId" type="text" placeholder="e.g. minD3D" />
        </div>
      </header>

      <div class="tabs" role="tablist">
        <button class="tab-btn active" data-tab="keywords" type="button">Keyword Extract</button>
        <button class="tab-btn" data-tab="dm" type="button">DM Message</button>
      </div>

      <section class="tab-panel active" data-panel="keywords">
        <div class="grid">
          <div>
            <div class="card">
              <div class="card-header">
                <h2>Request</h2>
                <span class="badge">POST /instagram/extract-keywords</span>
              </div>
              <div class="field">
                <label for="keywordVersion">Prompt Version</label>
                <select id="keywordVersion"></select>
              </div>
              <div class="field hidden" id="keywordCustomPromptField">
                <label for="customKeywordPrompt">Custom Keyword Prompt</label>
                <textarea
                  id="customKeywordPrompt"
                  rows="6"
                  placeholder="Paste a custom keyword prompt template."
                ></textarea>
                <div class="field-note">
                  Use {{profile_name}}, {{profile_bio}}, {{profile_category}}, {{post_captions}} placeholders.
                </div>
              </div>
              <label class="check">
                <input id="keywordIgnoreCache" type="checkbox" />
                ignoreCache
              </label>
              <div class="actions">
                <button class="btn" id="keywordBtn" type="button">Extract Keywords</button>
                <button class="btn secondary" id="promptBtn" type="button">Fetch Prompt Preview</button>
              </div>
              <div class="status" id="keywordStatus">Idle.</div>
              <div class="status" id="promptStatus"></div>
              <div class="payload">
                <div class="payload-header">
                  <span>Request JSON</span>
                  <button class="copy-btn" data-copy="keyword-request" type="button">Copy</button>
                </div>
                <textarea id="keywordRequestOutput" rows="7" readonly></textarea>
              </div>
            </div>
          </div>
          <div>
            <div class="card">
              <div class="card-header">
                <h2>Response</h2>
              </div>
              <div class="block">
                <div class="block-header">
                  <h3>Keywords</h3>
                  <button class="copy-btn" data-copy="keywords" type="button">Copy</button>
                </div>
                <div class="chips" id="keywordChips"></div>
              </div>
              <div class="block">
                <div class="block-header">
                  <h3>Prompt Template</h3>
                  <button class="copy-btn" data-copy="template" type="button">Copy</button>
                </div>
                <textarea id="templateOutput" rows="6" readonly></textarea>
              </div>
              <div class="block">
                <div class="block-header">
                  <h3>Prompt Preview</h3>
                  <button class="copy-btn" data-copy="prompt" type="button">Copy</button>
                </div>
                <textarea id="promptOutput" rows="6" readonly></textarea>
              </div>
              <div class="block">
                <div class="block-header">
                  <h3>Raw Response</h3>
                  <button class="copy-btn" data-copy="keyword-raw" type="button">Copy</button>
                </div>
                <div class="raw" id="keywordRawOutput">Waiting for response...</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="tab-panel" data-panel="dm">
        <div class="grid">
          <div>
            <div class="card">
              <div class="card-header">
                <h2>Request</h2>
                <span class="badge">POST /instagram/generate-dm</span>
              </div>
              <div class="field">
                <label for="dmKeywordVersion">Keyword Version</label>
                <select id="dmKeywordVersion"></select>
              </div>
              <div class="field hidden" id="dmKeywordCustomPromptField">
                <label for="customDmKeywordPrompt">Custom Keyword Prompt</label>
                <textarea
                  id="customDmKeywordPrompt"
                  rows="5"
                  placeholder="Custom keyword prompt template for DM flow."
                ></textarea>
                <div class="field-note">
                  Use {{profile_name}}, {{profile_bio}}, {{profile_category}}, {{post_captions}} placeholders.
                </div>
              </div>
              <div class="field">
                <label for="dmVersion">DM Prompt Version</label>
                <select id="dmVersion"></select>
              </div>
              <div class="field hidden" id="dmCustomPromptField">
                <label for="customDmPrompt">Custom DM Prompt</label>
                <textarea id="customDmPrompt" rows="5" placeholder="Custom DM prompt template."></textarea>
                <div class="field-note">
                  Use {{MOOD_KEYWORDS}}, {{CONTENT_KEYWORDS}}, {{TONE_KEYWORDS}}, {{IMPRESSION_SUMMARY}}
                  placeholders.
                </div>
              </div>
              <label class="check">
                <input id="dmIgnoreCache" type="checkbox" />
                ignoreCache
              </label>
              <div class="actions">
                <button class="btn" id="dmBtn" type="button">Generate DM</button>
              </div>
              <div class="status" id="dmStatus">Idle.</div>
              <div class="payload">
                <div class="payload-header">
                  <span>Request JSON</span>
                  <button class="copy-btn" data-copy="dm-request" type="button">Copy</button>
                </div>
                <textarea id="dmRequestOutput" rows="7" readonly></textarea>
              </div>
            </div>
          </div>
          <div>
            <div class="card">
              <div class="card-header">
                <h2>Response</h2>
              </div>
              <div class="block">
                <div class="block-header">
                  <h3>DM Message</h3>
                  <button class="copy-btn" data-copy="dm" type="button">Copy</button>
                </div>
                <textarea id="dmOutput" rows="6" readonly></textarea>
              </div>
              <div class="block">
                <div class="block-header">
                  <h3>Mood Keywords</h3>
                </div>
                <div class="chips" id="dmMoodChips"></div>
              </div>
              <div class="block">
                <div class="block-header">
                  <h3>Content Keywords</h3>
                </div>
                <div class="chips" id="dmContentChips"></div>
              </div>
              <div class="block">
                <div class="block-header">
                  <h3>Tone Keywords</h3>
                </div>
                <div class="chips" id="dmToneChips"></div>
              </div>
              <div class="block">
                <div class="block-header">
                  <h3>Impression Summary</h3>
                  <button class="copy-btn" data-copy="dm-summary" type="button">Copy</button>
                </div>
                <textarea id="dmSummaryOutput" rows="4" readonly></textarea>
              </div>
              <div class="block">
                <div class="block-header">
                  <h3>Raw Response</h3>
                  <button class="copy-btn" data-copy="dm-raw" type="button">Copy</button>
                </div>
                <div class="raw" id="dmRawOutput">Waiting for response...</div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <script>
      const userIdInput = document.getElementById("userId");
      const keywordVersionSelect = document.getElementById("keywordVersion");
      const keywordCustomPromptField = document.getElementById("keywordCustomPromptField");
      const customKeywordPromptInput = document.getElementById("customKeywordPrompt");
      const keywordIgnoreCache = document.getElementById("keywordIgnoreCache");
      const keywordRequestOutput = document.getElementById("keywordRequestOutput");
      const keywordBtn = document.getElementById("keywordBtn");
      const promptBtn = document.getElementById("promptBtn");
      const keywordStatusEl = document.getElementById("keywordStatus");
      const promptStatusEl = document.getElementById("promptStatus");
      const keywordChips = document.getElementById("keywordChips");
      const templateOutput = document.getElementById("templateOutput");
      const promptOutput = document.getElementById("promptOutput");
      const keywordRawOutput = document.getElementById("keywordRawOutput");

      const dmKeywordVersionSelect = document.getElementById("dmKeywordVersion");
      const dmKeywordCustomPromptField = document.getElementById("dmKeywordCustomPromptField");
      const customDmKeywordPromptInput = document.getElementById("customDmKeywordPrompt");
      const dmVersionSelect = document.getElementById("dmVersion");
      const dmCustomPromptField = document.getElementById("dmCustomPromptField");
      const customDmPromptInput = document.getElementById("customDmPrompt");
      const dmIgnoreCache = document.getElementById("dmIgnoreCache");
      const dmRequestOutput = document.getElementById("dmRequestOutput");
      const dmBtn = document.getElementById("dmBtn");
      const dmStatusEl = document.getElementById("dmStatus");
      const dmOutput = document.getElementById("dmOutput");
      const dmMoodChips = document.getElementById("dmMoodChips");
      const dmContentChips = document.getElementById("dmContentChips");
      const dmToneChips = document.getElementById("dmToneChips");
      const dmSummaryOutput = document.getElementById("dmSummaryOutput");
      const dmRawOutput = document.getElementById("dmRawOutput");

      const tabButtons = document.querySelectorAll(".tab-btn");
      const tabPanels = document.querySelectorAll(".tab-panel");
      const copyButtons = document.querySelectorAll("[data-copy]");
      const DEFAULT_KEYWORD_VERSION = "v2";
      const DEFAULT_DM_VERSION = "v1";
      let lastKeywordVersion = DEFAULT_KEYWORD_VERSION;
      let lastDmKeywordVersion = DEFAULT_KEYWORD_VERSION;
      let lastDmVersion = DEFAULT_DM_VERSION;

      function getCustomPrompt(selectEl, inputEl) {
        if (selectEl.value !== "custom") {
          return "";
        }
        const value = inputEl.value;
        return value.trim() ? value : "";
      }

      function resolveVersion(selectEl, lastValue, fallback) {
        if (selectEl.value && selectEl.value !== "custom") {
          return selectEl.value;
        }
        return lastValue || fallback;
      }

      function toggleCustomField(selectEl, fieldEl) {
        if (!fieldEl) {
          return;
        }
        fieldEl.classList.toggle("hidden", selectEl.value !== "custom");
      }

      function syncLastVersions() {
        if (keywordVersionSelect.value !== "custom") {
          lastKeywordVersion = keywordVersionSelect.value;
        }
        if (dmKeywordVersionSelect.value !== "custom") {
          lastDmKeywordVersion = dmKeywordVersionSelect.value;
        }
        if (dmVersionSelect.value !== "custom") {
          lastDmVersion = dmVersionSelect.value;
        }
      }

      function buildKeywordPayload() {
        return {
          userId: userIdInput.value.trim(),
          version: resolveVersion(keywordVersionSelect, lastKeywordVersion, DEFAULT_KEYWORD_VERSION),
          customPrompt: getCustomPrompt(keywordVersionSelect, customKeywordPromptInput),
          ignoreCache: keywordIgnoreCache.checked,
        };
      }

      function buildDmPayload() {
        return {
          userId: userIdInput.value.trim(),
          version: resolveVersion(dmKeywordVersionSelect, lastDmKeywordVersion, DEFAULT_KEYWORD_VERSION),
          customKeywordPrompt: getCustomPrompt(dmKeywordVersionSelect, customDmKeywordPromptInput),
          dmVersion: resolveVersion(dmVersionSelect, lastDmVersion, DEFAULT_DM_VERSION),
          customDmPrompt: getCustomPrompt(dmVersionSelect, customDmPromptInput),
          ignoreCache: dmIgnoreCache.checked,
        };
      }

      function setRequestPreview(target, payload) {
        target.value = JSON.stringify(payload, null, 2);
      }

      function setStatus(target, message, type) {
        target.textContent = message;
        target.className = "status" + (type ? " " + type : "");
      }

      function renderChips(target, items, className) {
        target.innerHTML = "";
        if (!items || items.length === 0) {
          target.innerHTML = "<span class=\"chip alt\">(empty)</span>";
          return;
        }
        items.forEach((item) => {
          const chip = document.createElement("span");
          chip.className = "chip" + (className ? " " + className : "");
          chip.textContent = item;
          target.appendChild(chip);
        });
      }

      async function fetchKeywordTemplate(version) {
        try {
          const response = await fetch("/instagram/keyword-prompt", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId: "", version }),
          });
          if (!response.ok) {
            return "";
          }
          const data = await response.json();
          return data.template || "";
        } catch (err) {
          return "";
        }
      }

      async function fetchDmTemplate(version) {
        try {
          const response = await fetch("/instagram/dm-prompt", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ version }),
          });
          if (!response.ok) {
            return "";
          }
          const data = await response.json();
          return data.template || "";
        } catch (err) {
          return "";
        }
      }

      async function fillKeywordCustomPrompt(selectEl, inputEl, version, previewTarget, payloadBuilder) {
        if (selectEl.value !== "custom") {
          return;
        }
        if (inputEl.value.trim()) {
          return;
        }
        const template = await fetchKeywordTemplate(version);
        if (!template) {
          return;
        }
        inputEl.value = template;
        setRequestPreview(previewTarget, payloadBuilder());
      }

      async function fillDmCustomPrompt(selectEl, inputEl, version, previewTarget, payloadBuilder) {
        if (selectEl.value !== "custom") {
          return;
        }
        if (inputEl.value.trim()) {
          return;
        }
        const template = await fetchDmTemplate(version);
        if (!template) {
          return;
        }
        inputEl.value = template;
        setRequestPreview(previewTarget, payloadBuilder());
      }

      function updateRequestPreviews() {
        syncLastVersions();
        toggleCustomField(keywordVersionSelect, keywordCustomPromptField);
        toggleCustomField(dmKeywordVersionSelect, dmKeywordCustomPromptField);
        toggleCustomField(dmVersionSelect, dmCustomPromptField);
        setRequestPreview(keywordRequestOutput, buildKeywordPayload());
        setRequestPreview(dmRequestOutput, buildDmPayload());
        const keywordVersion = resolveVersion(
          keywordVersionSelect,
          lastKeywordVersion,
          DEFAULT_KEYWORD_VERSION,
        );
        const dmKeywordVersion = resolveVersion(
          dmKeywordVersionSelect,
          lastDmKeywordVersion,
          DEFAULT_KEYWORD_VERSION,
        );
        const dmVersion = resolveVersion(dmVersionSelect, lastDmVersion, DEFAULT_DM_VERSION);
        void fillKeywordCustomPrompt(
          keywordVersionSelect,
          customKeywordPromptInput,
          keywordVersion,
          keywordRequestOutput,
          buildKeywordPayload,
        );
        void fillKeywordCustomPrompt(
          dmKeywordVersionSelect,
          customDmKeywordPromptInput,
          dmKeywordVersion,
          dmRequestOutput,
          buildDmPayload,
        );
        void fillDmCustomPrompt(
          dmVersionSelect,
          customDmPromptInput,
          dmVersion,
          dmRequestOutput,
          buildDmPayload,
        );
      }

      async function runPromptPreview() {
        const payload = buildKeywordPayload();
        if (!payload.userId) {
          setStatus(promptStatusEl, "Username is required for prompt preview.", "error");
          return;
        }
        setStatus(promptStatusEl, "Fetching prompt preview...", "info");
        templateOutput.value = "Loading...";
        promptOutput.value = "Loading...";

        try {
          const response = await fetch("/instagram/keyword-prompt", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              userId: payload.userId,
              version: payload.version,
              customPrompt: payload.customPrompt,
            }),
          });
          if (!response.ok) {
            setStatus(promptStatusEl, "Prompt preview failed: " + response.status, "error");
            templateOutput.value = "(failed)";
            promptOutput.value = "(failed)";
            return;
          }
          const data = await response.json();
          templateOutput.value = data.template || "(empty template)";
          promptOutput.value = data.prompt || "(empty prompt)";
          setStatus(promptStatusEl, "Prompt preview updated.", "success");
        } catch (err) {
          setStatus(promptStatusEl, "Network error: " + err.message, "error");
        }
      }

      async function runKeywordExtraction() {
        const payload = buildKeywordPayload();
        if (!payload.userId) {
          setStatus(keywordStatusEl, "Username is required for keyword extraction.", "error");
          return;
        }
        setStatus(keywordStatusEl, "Requesting keywords...", "info");
        keywordRawOutput.textContent = "Loading...";
        keywordChips.innerHTML = "";

        try {
          const response = await fetch("/instagram/extract-keywords", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const text = await response.text();
          keywordRawOutput.textContent = text || "(empty response)";
          if (!response.ok) {
            setStatus(keywordStatusEl, "Request failed: " + response.status, "error");
            return;
          }
          let data = null;
          try {
            data = JSON.parse(text);
          } catch (err) {
            setStatus(keywordStatusEl, "Failed to parse JSON response.", "error");
            return;
          }
          renderChips(keywordChips, data.keywords, "");
          setStatus(keywordStatusEl, "Keyword extraction complete.", "success");
        } catch (err) {
          setStatus(keywordStatusEl, "Network error: " + err.message, "error");
        }
      }

      async function runDmGeneration() {
        const payload = buildDmPayload();
        if (!payload.userId) {
          setStatus(dmStatusEl, "Username is required for DM generation.", "error");
          return;
        }
        setStatus(dmStatusEl, "Generating DM...", "info");
        dmOutput.value = "Loading...";
        dmRawOutput.textContent = "Loading...";
        dmSummaryOutput.value = "";
        dmMoodChips.innerHTML = "";
        dmContentChips.innerHTML = "";
        dmToneChips.innerHTML = "";

        try {
          const response = await fetch("/instagram/generate-dm", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const text = await response.text();
          dmRawOutput.textContent = text || "(empty response)";
          if (!response.ok) {
            setStatus(dmStatusEl, "Request failed: " + response.status, "error");
            dmOutput.value = "(failed)";
            return;
          }
          let data = null;
          try {
            data = JSON.parse(text);
          } catch (err) {
            setStatus(dmStatusEl, "Failed to parse JSON response.", "error");
            dmOutput.value = "(invalid response)";
            return;
          }
          dmOutput.value = data.message || "(empty message)";
          renderChips(dmMoodChips, data.moodKeywords, "");
          renderChips(dmContentChips, data.contentKeywords, "");
          renderChips(dmToneChips, data.toneKeywords, "alt");
          dmSummaryOutput.value = data.impressionSummary || "(empty summary)";
          setStatus(dmStatusEl, "DM generation complete.", "success");
        } catch (err) {
          setStatus(dmStatusEl, "Network error: " + err.message, "error");
          dmOutput.value = "(network error)";
        }
      }

      async function loadVersions() {
        try {
          const response = await fetch("/instagram/keyword-versions");
          const versions = response.ok ? await response.json() : [];
          populateSelect(keywordVersionSelect, versions, "v2");
          populateSelect(dmKeywordVersionSelect, versions, "v2", "v3");
        } catch (err) {
          populateSelect(keywordVersionSelect, [], "v2");
          populateSelect(dmKeywordVersionSelect, [], "v2", "v3");
        }

        try {
          const response = await fetch("/instagram/dm-versions");
          const versions = response.ok ? await response.json() : [];
          populateSelect(dmVersionSelect, versions, "v1");
        } catch (err) {
          populateSelect(dmVersionSelect, [], "v1");
        }

        updateRequestPreviews();
      }

      function populateSelect(selectEl, versions, fallback, preferred) {
        selectEl.innerHTML = "";
        let preferredFound = false;
        if (!versions || versions.length === 0) {
          const option = document.createElement("option");
          option.value = fallback;
          option.textContent = fallback + " (default)";
          selectEl.appendChild(option);
        } else {
          versions.forEach((version, index) => {
            const option = document.createElement("option");
            option.value = version;
            if (preferred && version === preferred) {
              option.textContent = version + " (default)";
              option.selected = true;
              preferredFound = true;
            } else {
              option.textContent = version + (!preferred && index === 0 ? " (default)" : "");
            }
            selectEl.appendChild(option);
          });
        }
        const custom = document.createElement("option");
        custom.value = "custom";
        custom.textContent = "custom";
        selectEl.appendChild(custom);
        if (preferred && !preferredFound) {
          const match = Array.from(selectEl.options).some((option) => option.value === preferred);
          if (match) {
            selectEl.value = preferred;
          }
        }
      }

      function copyTextToClipboard(text) {
        if (navigator.clipboard && window.isSecureContext) {
          return navigator.clipboard.writeText(text);
        }
        const temp = document.createElement("textarea");
        temp.value = text;
        temp.setAttribute("readonly", "");
        temp.style.position = "absolute";
        temp.style.left = "-9999px";
        document.body.appendChild(temp);
        temp.select();
        const ok = document.execCommand("copy");
        document.body.removeChild(temp);
        if (!ok) {
          throw new Error("Copy not permitted");
        }
        return Promise.resolve();
      }

      tabButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const tab = button.dataset.tab;
          tabButtons.forEach((btn) => btn.classList.remove("active"));
          button.classList.add("active");
          tabPanels.forEach((panel) => {
            panel.classList.toggle("active", panel.dataset.panel === tab);
          });
        });
      });

      copyButtons.forEach((button) => {
        button.addEventListener("click", async () => {
          const target = button.dataset.copy;
          let text = "";
          if (target === "keywords") {
            text = Array.from(keywordChips.querySelectorAll(".chip"))
              .map((chip) => chip.textContent)
              .join(", ");
          } else if (target === "template") {
            text = templateOutput.value;
          } else if (target === "prompt") {
            text = promptOutput.value;
          } else if (target === "keyword-raw") {
            text = keywordRawOutput.textContent;
          } else if (target === "keyword-request") {
            text = keywordRequestOutput.value;
          } else if (target === "dm") {
            text = dmOutput.value;
          } else if (target === "dm-summary") {
            text = dmSummaryOutput.value;
          } else if (target === "dm-raw") {
            text = dmRawOutput.textContent;
          } else if (target === "dm-request") {
            text = dmRequestOutput.value;
          }

          if (!text) {
            return;
          }
          await copyTextToClipboard(text);
        });
      });

      keywordBtn.addEventListener("click", runKeywordExtraction);
      promptBtn.addEventListener("click", runPromptPreview);
      dmBtn.addEventListener("click", runDmGeneration);

      [
        userIdInput,
        keywordVersionSelect,
        customKeywordPromptInput,
        keywordIgnoreCache,
        dmKeywordVersionSelect,
        customDmKeywordPromptInput,
        dmVersionSelect,
        customDmPromptInput,
        dmIgnoreCache,
      ].forEach((el) => {
        el.addEventListener("input", updateRequestPreviews);
        el.addEventListener("change", updateRequestPreviews);
      });

      loadVersions();
    </script>
  </body>
</html>
